# DiffSBDD 迭代学习系统 - 统一配置文件
# 版本: v1.2
# 更新日期: 2024-10-25

# ============================================================================
# 文件路径配置
# ============================================================================
paths:
  # 预训练模型检查点路径
  checkpoint: "./checkpoints/crossdocked_fullatom_cond.ckpt"
  
  # 蛋白质PDB文件路径
  pdbfile: "./proteins/RE-CmeB.pdb"
  
  # 输出目录路径
  output_dir: "./results/RE-CmeB_iterative"

# ============================================================================
# 口袋定义（二选一）
# ============================================================================
pocket:
  # 选项1: 使用参考配体定义口袋
  # 格式: "链:残基ID" 或 "path/to/ligand.sdf"
  ref_ligand: "A:330"
  
  # 选项2: 使用残基列表定义口袋
  # 格式: ["链:残基ID", "链:残基ID", ...]
  # pocket_ids: null
  pocket_ids: null

# ============================================================================
# 迭代参数
# ============================================================================
iteration:
  # 迭代次数
  n_iterations: 30
  
  # 每次迭代的训练轮数
  train_epochs: 50
  
  # 冻结的EGNN底层数量（共5层，推荐冻结前3层）
  freeze_layers: 3

# ============================================================================
# 训练参数
# ============================================================================
training:
  # 批次大小（根据GPU内存调整）
  # 8GB GPU -> 4, 12GB GPU -> 8, 24GB GPU -> 16
  batch_size: 8
  
  # 学习率
  learning_rate: 0.0001
  
  # 优化器类型
  optimizer: "AdamW"
  
  # 早停patience
  early_stopping_patience: 10

# ============================================================================
# 生成参数
# ============================================================================
generation:
  # 去噪步数（null表示使用训练时的默认值）
  timesteps: null
  
  # 第一次迭代生成的分子数量
  initial_molecules: 2000
  
  # 后续迭代生成的分子数量
  subsequent_molecules: 1000
  
  # 每次迭代选择的分子数量
  n_select: 1000

# ============================================================================
# 评估参数
# ============================================================================
evaluation:
  # 是否使用对接打分（需要安装smina）
  use_docking: false
  
  # 评分权重
  weights:
    QED: 0.25        # 类药性
    SA: 0.25         # 合成可及性
    LogP: 0.15       # 亲脂性
    Lipinski: 0.15   # Lipinski规则
    Docking: 0.20    # 对接打分（仅当use_docking=true时有效）

# ============================================================================
# 不确定性选择参数（基于主动学习）
# ============================================================================
uncertainty:
  # 初始探索权重（0-1），控制前期探索化学空间的激进程度
  # 推荐值：0.4-0.6
  alpha_start: 0.5
  
  # 最终探索权重（0-1），控制后期是否保持轻微探索
  # 推荐值：0.01-0.05
  alpha_end: 0.03
  
  # Morgan指纹半径
  fingerprint_radius: 2
  
  # 指纹位数
  fingerprint_bits: 2048
  
  # 是否启用并行计算指纹（大量分子时更快）
  parallel_fingerprint: true
  
  # 并行计算的分子数量阈值
  parallel_threshold: 100

# ============================================================================
# 性能优化参数
# ============================================================================
performance:
  # 内存管理
  memory:
    # 是否启用内存监控（需要psutil）
    enable_monitoring: true
    
    # 是否主动清理内存
    aggressive_cleanup: true
  
  # 并行处理
  parallel:
    # 评估时的工作进程数（null表示自动检测）
    n_workers: null
    
    # 是否启用多进程指纹计算
    enable_parallel_fingerprint: true

# ============================================================================
# 日志配置
# ============================================================================
logging:
  # 日志级别: DEBUG, INFO, WARNING, ERROR
  level: "INFO"
  
  # 是否保存日志到文件
  save_to_file: true
  
  # 日志文件格式
  file_format: "training_%(timestamp)s.log"
  
  # 控制台日志格式
  console_format: "%(asctime)s - %(levelname)s - %(message)s"

# ============================================================================
# 恢复训练
# ============================================================================
resume:
  # 从指定迭代恢复训练（null表示从头开始）
  resume_from: null
  
  # 是否在遇到错误时继续执行
  continue_on_error: true
  
  # 自动保存检查点的频率（每N次迭代）
  checkpoint_frequency: 1

# ============================================================================
# 高级选项
# ============================================================================
advanced:
  # 数据集类型
  dataset: "crossdock"
  
  # 口袋表示方式: "CA" 或 "full-atom"
  pocket_representation: "full-atom"
  
  # 随机种子（用于可重现性，null表示随机）
  random_seed: 42
  
  # GPU设备ID（null表示自动选择）
  gpu_device: null
  
  # 是否启用混合精度训练
  mixed_precision: false

# ============================================================================
# 实验场景预设（可快速切换配置）
# ============================================================================
presets:
  # 默认配置（平衡性能和质量）
  default:
    train_epochs: 50
    freeze_layers: 3
    batch_size: 8
    learning_rate: 0.0001
  
  # 快速测试（用于验证流程）
  quick_test:
    n_iterations: 3
    train_epochs: 10
    freeze_layers: 3
    batch_size: 8
    initial_molecules: 100
    subsequent_molecules: 50
    n_select: 50
  
  # 高质量（追求最佳结果）
  high_quality:
    train_epochs: 100
    freeze_layers: 2
    batch_size: 8
    learning_rate: 0.00005
    use_docking: true
  
  # 快速训练（GPU内存有限）
  fast_training:
    train_epochs: 30
    freeze_layers: 4
    batch_size: 4
    learning_rate: 0.0001

# ============================================================================
# 说明
# ============================================================================
# 使用方法：
# 1. 直接修改此配置文件
# 2. 或在命令行中使用 --config 参数指定配置文件
# 3. 命令行参数优先级高于配置文件
#
# 示例：
#   python iterative_generation.py --config config.yaml
#   python iterative_generation.py --config config.yaml --batch_size 16
#
# 预设使用：
#   python iterative_generation.py --preset quick_test
#   python iterative_generation.py --preset high_quality

